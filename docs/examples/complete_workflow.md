# STUNIR Complete Workflow Example

> Part of `docs/examples/complete/1039`

## Overview

This example demonstrates a complete STUNIR build workflow from specification to verification.

## Step 1: Create Specification

Create `spec.json`:

```json
{
  "module": "calculator",
  "functions": [
    {
      "name": "add",
      "params": [
        {"name": "a", "type": "i32"},
        {"name": "b", "type": "i32"}
      ],
      "return_type": "i32",
      "body": {
        "op": "binop",
        "operator": "+",
        "left": {"op": "var", "name": "a"},
        "right": {"op": "var", "name": "b"}
      }
    },
    {
      "name": "multiply",
      "params": [
        {"name": "x", "type": "i32"},
        {"name": "y", "type": "i32"}
      ],
      "return_type": "i32",
      "body": {
        "op": "binop",
        "operator": "*",
        "left": {"op": "var", "name": "x"},
        "right": {"op": "var", "name": "y"}
      }
    }
  ],
  "types": [],
  "imports": [],
  "exports": ["add", "multiply"]
}
```

## Step 2: Generate IR

```bash
# Using Python
python -m tools.ir_emitter.emit_ir spec.json asm/ir/calculator.json

# Or using native tools
stunir-native gen-ir-manifest --ir-dir asm/ir --out receipts/ir_manifest.json
```

**Output: `asm/ir/calculator.json`**
```json
{
  "module": "calculator",
  "ir_epoch": 1735500000,
  "ir_spec_hash": "sha256:abc123...",
  "functions": [
    {
      "name": "add",
      "params": [{"name": "a", "type": "i32"}, {"name": "b", "type": "i32"}],
      "return_type": "i32",
      "body": [{"op": "binop", "operator": "+", "left": {"op": "var", "name": "a"}, "right": {"op": "var", "name": "b"}}]
    },
    {
      "name": "multiply",
      "params": [{"name": "x", "type": "i32"}, {"name": "y", "type": "i32"}],
      "return_type": "i32",
      "body": [{"op": "binop", "operator": "*", "left": {"op": "var", "name": "x"}, "right": {"op": "var", "name": "y"}}]
    }
  ],
  "types": [],
  "imports": [],
  "exports": ["add", "multiply"]
}
```

## Step 3: Generate Targets

### Rust Target
```bash
python -m tools.emitters.emit_code --target rust --ir asm/ir/calculator.json --output targets/polyglot/rust/
```

**Output: `targets/polyglot/rust/src/lib.rs`**
```rust
// Generated by STUNIR
pub fn add(a: i32, b: i32) -> i32 {
    a + b
}

pub fn multiply(x: i32, y: i32) -> i32 {
    x * y
}
```

### C89 Target
```bash
python -m tools.emitters.emit_code --target c89 --ir asm/ir/calculator.json --output targets/polyglot/c89/
```

**Output: `targets/polyglot/c89/calculator.c`**
```c
/* Generated by STUNIR */
#include "calculator.h"

int add(int a, int b) {
    return a + b;
}

int multiply(int x, int y) {
    return x * y;
}
```

## Step 4: Generate Manifests

```bash
# IR Manifest
python -m manifests.ir.gen_ir_manifest --output receipts/ir_manifest.json

# Targets Manifest
python -m manifests.targets.gen_targets_manifest --output receipts/targets_manifest.json

# Receipts Manifest
python -m manifests.receipts.gen_receipts_manifest --output receipts/receipts_manifest.json
```

**Output: `receipts/ir_manifest.json`**
```json
{
  "schema": "stunir.manifest.ir.v1",
  "epoch": 1735500000,
  "entries": [
    {
      "name": "calculator.json",
      "path": "asm/ir/calculator.json",
      "hash": "sha256:abc123...",
      "size": 1024
    }
  ],
  "manifest_hash": "sha256:def456..."
}
```

## Step 5: Verify

```bash
# Standard verification
./scripts/verify.sh

# Strict verification
./scripts/verify_strict.sh --strict
```

**Output:**
```
[VERIFY] Checking IR manifest...
[VERIFY] asm/ir/calculator.json: OK
[VERIFY] Checking targets manifest...
[VERIFY] targets/polyglot/rust/src/lib.rs: OK
[VERIFY] targets/polyglot/c89/calculator.c: OK
[VERIFY] All checks passed!
```

## Step 6: Build Targets

```bash
# Build Rust
cd targets/polyglot/rust && cargo build --release

# Build C89
cd targets/polyglot/c89 && make
```

## Full Pipeline Script

```bash
#!/bin/bash
set -e

# Full STUNIR pipeline
echo "[1/5] Generating IR..."
python -m tools.ir_emitter.emit_ir spec.json asm/ir/calculator.json

echo "[2/5] Generating targets..."
python -m tools.emitters.emit_code --target rust --ir asm/ir/calculator.json --output targets/polyglot/rust/
python -m tools.emitters.emit_code --target c89 --ir asm/ir/calculator.json --output targets/polyglot/c89/

echo "[3/5] Generating manifests..."
python -m manifests.ir.gen_ir_manifest
python -m manifests.targets.gen_targets_manifest
python -m manifests.receipts.gen_receipts_manifest

echo "[4/5] Verifying..."
./scripts/verify_strict.sh --strict

echo "[5/5] Building targets..."
(cd targets/polyglot/rust && cargo build --release)
(cd targets/polyglot/c89 && make)

echo "Pipeline complete!"
```

## Related
- [Examples Index](README.md)
- [Pipeline Design](../design/pipeline.md)
- [API Reference](../api/README.md)

---
*STUNIR Complete Workflow Example v1.0*
