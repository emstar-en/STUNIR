# STUNIR ROCm Kernel Patterns

Advanced GPU kernel implementations for AMD ROCm platform.

## Kernels

### 1. 2D Convolution (`conv2d.hip`)

Optimized 2D convolution with multiple implementations:
- **Naive**: Simple implementation for reference
- **Tiled**: Shared memory tiling with halo regions
- **Separable**: Two-pass for separable filters (Gaussian, Sobel)

**Features:**
- Arbitrary filter sizes (up to 7x7 in shared memory)
- Configurable padding and stride
- ~3-5x speedup over naive implementation

```bash
hipcc -O3 -o conv2d conv2d.hip
./conv2d
```

### 2. Fast Fourier Transform (`fft.hip`)

Cooley-Tukey FFT algorithm:
- **Radix-2**: Standard butterfly operations
- **Radix-4**: Better arithmetic intensity
- **2D FFT**: Row-column decomposition

**Features:**
- In-place computation
- Bit-reversal permutation
- Forward and inverse transforms
- Normalization for inverse

```bash
hipcc -O3 -o fft fft.hip
./fft
```

### 3. Sparse Matrix-Vector Multiplication (`sparse_matvec.hip`)

CSR format SpMV with multiple strategies:
- **Scalar**: One thread per row (simple)
- **Vector**: One warp per row (load balanced)
- **Adaptive**: Chooses strategy based on row length
- **ELL**: Alternative format for regular sparsity

**Features:**
- AMD wavefront (64-thread) optimized
- Warp shuffle reduction
- Supports arbitrary sparsity patterns

```bash
hipcc -O3 -o sparse_matvec sparse_matvec.hip
./sparse_matvec
```

### 4. Matrix Transpose (`transpose.hip`)

Optimized transpose implementations:
- **Naive**: Direct transpose (bank conflicts + non-coalesced)
- **Coalesced**: Shared memory staging
- **Optimized**: Padded shared memory (no bank conflicts)
- **In-place**: For square matrices
- **Batched**: Process multiple matrices

**Features:**
- ~10x speedup over naive
- Near-theoretical bandwidth
- Bank conflict elimination

```bash
hipcc -O3 -o transpose transpose.hip
./transpose
```

## Build All Kernels

```bash
#!/bin/bash
# build_kernels.sh

set -e

KERNELS="conv2d fft sparse_matvec transpose"

for kernel in $KERNELS; do
    echo "Building $kernel..."
    hipcc -O3 -o $kernel ${kernel}.hip
done

echo "All kernels built successfully!"
```

## Performance Characteristics

| Kernel | Key Optimization | Expected Speedup |
|--------|-----------------|------------------|
| conv2d | Shared memory tiling | 3-5x |
| fft | In-place radix-2 | Memory-bound |
| sparse_matvec | Warp-level reduction | 2-4x |
| transpose | Bank conflict elimination | 5-10x |

## Architecture Notes

### AMD RDNA3 (RX 7000 series)
- 32-wide wavefronts (can be 32 or 64)
- Large L2 cache (96MB on 7900 XTX)
- Infinity Cache for bandwidth

### AMD CDNA3 (MI300 series)
- 64-wide wavefronts
- HBM3 memory (5.3 TB/s on MI300X)
- Matrix cores for GEMM
- Designed for compute workloads

## Integration with STUNIR

These kernels demonstrate patterns that can be generated by the STUNIR GPU emitter:

```python
from targets.gpu.emitter import GpuEmitter

# Generate similar patterns from IR
emitter = GpuEmitter(ir_data, 'output', {'backend': 'rocm'})
emitter.emit()
```

## Schema

- `stunir.gpu.rocm.kernel.conv2d.v1`
- `stunir.gpu.rocm.kernel.fft.v1`
- `stunir.gpu.rocm.kernel.sparse_matvec.v1`
- `stunir.gpu.rocm.kernel.transpose.v1`
