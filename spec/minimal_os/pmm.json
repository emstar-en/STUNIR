{
  "schema": "stunir.spec.v1",
  "module": "pmm",
  "description": "Physical Memory Manager - bitmap-based page allocator for STUNIR minimal OS",
  "target": {
    "architecture": "x86_64",
    "format": "c",
    "standard": "c89"
  },
  "constants": [
    {"name": "PAGE_SIZE", "type": "u32", "value": "4096"},
    {"name": "MAX_MEMORY_MB", "type": "u32", "value": "256"},
    {"name": "MAX_PAGES", "type": "u32", "value": "(MAX_MEMORY_MB * 1024 * 1024) / PAGE_SIZE"},
    {"name": "BITMAP_SIZE", "type": "u32", "value": "MAX_PAGES / 8"},
    {"name": "KERNEL_START", "type": "u64", "value": "0x100000"},
    {"name": "KERNEL_END", "type": "u64", "value": "0x400000"}
  ],
  "types": [
    {
      "name": "pmm_status",
      "kind": "enum",
      "values": ["PMM_OK", "PMM_OUT_OF_MEMORY", "PMM_INVALID_ADDRESS", "PMM_DOUBLE_FREE"]
    }
  ],
  "globals": [
    {"name": "memory_bitmap", "type": "u8[BITMAP_SIZE]"},
    {"name": "total_memory", "type": "u64"},
    {"name": "free_pages", "type": "u64"},
    {"name": "used_pages", "type": "u64"}
  ],
  "functions": [
    {
      "name": "pmm_init",
      "description": "Initialize physical memory manager with memory map",
      "params": [
        {"name": "total_mem", "type": "u64"}
      ],
      "returns": "void",
      "body": [
        {"type": "var_decl", "var_name": "i", "var_type": "u32"},
        {"type": "comment", "text": "Clear bitmap - mark all as used"},
        {"type": "for", "init": "i = 0", "condition": "i < BITMAP_SIZE", "increment": "i++", "body": [
          {"type": "assign", "target": "memory_bitmap[i]", "value": "0xFF"}
        ]},
        {"type": "assign", "target": "total_memory", "value": "total_mem"},
        {"type": "assign", "target": "free_pages", "value": "0"},
        {"type": "assign", "target": "used_pages", "value": "total_mem / PAGE_SIZE"}
      ]
    },
    {
      "name": "pmm_mark_free",
      "description": "Mark a page as free",
      "params": [
        {"name": "address", "type": "u64"}
      ],
      "returns": "void",
      "body": [
        {"type": "var_decl", "var_name": "page", "var_type": "u32", "init": "address / PAGE_SIZE"},
        {"type": "var_decl", "var_name": "byte_idx", "var_type": "u32", "init": "page / 8"},
        {"type": "var_decl", "var_name": "bit_idx", "var_type": "u32", "init": "page % 8"},
        {"type": "assign", "target": "memory_bitmap[byte_idx]", "value": "memory_bitmap[byte_idx] & ~(1 << bit_idx)"},
        {"type": "assign", "target": "free_pages", "value": "free_pages + 1"},
        {"type": "assign", "target": "used_pages", "value": "used_pages - 1"}
      ]
    },
    {
      "name": "pmm_mark_used",
      "description": "Mark a page as used",
      "params": [
        {"name": "address", "type": "u64"}
      ],
      "returns": "void",
      "body": [
        {"type": "var_decl", "var_name": "page", "var_type": "u32", "init": "address / PAGE_SIZE"},
        {"type": "var_decl", "var_name": "byte_idx", "var_type": "u32", "init": "page / 8"},
        {"type": "var_decl", "var_name": "bit_idx", "var_type": "u32", "init": "page % 8"},
        {"type": "assign", "target": "memory_bitmap[byte_idx]", "value": "memory_bitmap[byte_idx] | (1 << bit_idx)"}
      ]
    },
    {
      "name": "pmm_alloc_page",
      "description": "Allocate a single physical page",
      "params": [],
      "returns": "u64",
      "body": [
        {"type": "var_decl", "var_name": "i", "var_type": "u32"},
        {"type": "var_decl", "var_name": "j", "var_type": "u32"},
        {"type": "for", "init": "i = 0", "condition": "i < BITMAP_SIZE", "increment": "i++", "body": [
          {"type": "if", "condition": "memory_bitmap[i] != 0xFF", "then": [
            {"type": "for", "init": "j = 0", "condition": "j < 8", "increment": "j++", "body": [
              {"type": "if", "condition": "!(memory_bitmap[i] & (1 << j))", "then": [
                {"type": "var_decl", "var_name": "page", "var_type": "u32", "init": "i * 8 + j"},
                {"type": "call", "func": "pmm_mark_used", "args": ["page * PAGE_SIZE"]},
                {"type": "return", "value": "(u64)(page * PAGE_SIZE)"}
              ]}
            ]}
          ]}
        ]},
        {"type": "return", "value": "0"}
      ]
    },
    {
      "name": "pmm_free_page",
      "description": "Free a physical page",
      "params": [
        {"name": "address", "type": "u64"}
      ],
      "returns": "void",
      "body": [
        {"type": "if", "condition": "address == 0", "then": [{"type": "return"}]},
        {"type": "call", "func": "pmm_mark_free", "args": ["address"]}
      ]
    },
    {
      "name": "pmm_get_free_pages",
      "description": "Get number of free pages",
      "params": [],
      "returns": "u64",
      "body": [
        {"type": "return", "value": "free_pages"}
      ]
    }
  ]
}
