#!/usr/bin/env python3
"""Emit deterministic PHP hosted-runtime artifacts from the IR manifest.

V0 semantics: introspection/stub.
"""

import argparse
import json
from pathlib import Path


def load_ir_manifest(path: Path) -> dict:
    obj = json.loads(path.read_text(encoding='utf-8'))
    if not isinstance(obj, dict) or obj.get('schema') not in ('stunir.ir_manifest.v2',):
        raise SystemExit(f'Unexpected IR manifest schema in {path}: {obj.get("schema")!r}')
    return obj


def write_text(path: Path, text: str) -> None:
    path.parent.mkdir(parents=True, exist_ok=True)
    path.write_text(text, encoding='utf-8', newline='
')


def gen_main_php() -> str:
    return """<?php
// Generated by STUNIR (php backend, v0)

def sha256_file($p) {
    $b = file_get_contents($p);
    return hash('sha256', $b);
}

def find_repo_root($start) {
    $cur = realpath($start);
    for ($i = 0; $i < 16; $i++) {
        $irm = $cur . DIRECTORY_SEPARATOR . 'receipts' . DIRECTORY_SEPARATOR . 'ir_manifest.json';
        $irdir = $cur . DIRECTORY_SEPARATOR . 'asm' . DIRECTORY_SEPARATOR . 'ir';
        if (file_exists($irm) && is_dir($irdir)) return $cur;
        $parent = realpath($cur . DIRECTORY_SEPARATOR . '..');
        if ($parent === false || $parent === $cur) break;
        $cur = $parent;
    }
    throw new Exception('Could not locate repo root from ' . $start);
}

$repo = find_repo_root(__DIR__);
$ir_manifest_path = $repo . DIRECTORY_SEPARATOR . 'receipts' . DIRECTORY_SEPARATOR . 'ir_manifest.json';
$ir = json_decode(file_get_contents($ir_manifest_path), true);
$files = (is_array($ir) && isset($ir['files']) && is_array($ir['files'])) ? $ir['files'] : [];

$ir_files = [];
foreach ($files as $f) {
    $ir_files[] = [
        'file' => $f['file'] ?? null,
        'sha256' => $f['sha256'] ?? null,
        'bytes_len' => $f['bytes_len'] ?? null,
    ];
}

$out = [
    'schema' => 'stunir.php_sample_run.v0',
    'variant' => 'hosted',
    'ir_manifest_sha256' => sha256_file($ir_manifest_path),
    'ir_files_count' => count($ir_files),
    'ir_files' => $ir_files,
];

echo json_encode($out, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) . "
";
"""


def main() -> None:
    ap = argparse.ArgumentParser()
    ap.add_argument('--variant', required=True, choices=['hosted'])
    ap.add_argument('--ir-manifest', required=True)
    ap.add_argument('--out-root', required=True)
    args = ap.parse_args()

    _ = load_ir_manifest(Path(args.ir_manifest))

    out_root = Path(args.out_root)
    out_root.mkdir(parents=True, exist_ok=True)

    write_text(out_root / 'main.php', gen_main_php())

    readme = """# STUNIR PHP target (hosted)

This directory is generated.

- `main.php` prints a deterministic JSON summary derived from `receipts/ir_manifest.json`.

Run (from repo root):
- `php asm/php/app/main.php`
"""
    write_text(out_root / 'README.md', readme)


if __name__ == '__main__':
    main()
