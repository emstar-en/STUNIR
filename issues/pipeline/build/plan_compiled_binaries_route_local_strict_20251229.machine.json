{"category":["pipeline","build"],"id":"PLAN.BUILD.0001","payload":{"acceptance":{"critical_invariants":["receipts/*.json and receipts/*_manifest.json are canonical JSON per tools/verify_build.py","receipt_core_id_sha256 matches verifier compute_receipt_core_id() exactly","receipt epoch fields match build/epoch.json exactly"],"must_pass":["scripts/build.sh produces: build/epoch.json, build/spec.json, build/ir.json, build/provenance.json, build/provenance.h, build/provenance.bin, receipts/spec_ir.json, receipts/prov_emit.json, receipts/ir_manifest.json, receipts/ir_bundle_manifest.json","scripts/verify.sh (local strict) passes using tools/verify_build.py local mode requirements"]},"breakages_to_fix":[{"files":["scripts/lib/dispatch.sh"],"id":"dispatch_missing_symbols","severity":"hard_fail","symptom":"scripts/build.sh calls log_info, stunir_dispatch, stunir_canon_echo but dispatch.sh defines none"},{"files":["scripts/lib/receipt.sh"],"id":"receipt_schema_mismatch","severity":"hard_fail","symptom":"receipt.sh emits arbitrary env keys; verifier requires stunir.receipt.build.v1 + receipt_core_id_sha256"},{"files":["tools/native/rust/stunir-native/src/main.rs"],"id":"native_receipt_compile_error_and_core_id_logic","severity":"hard_fail_for_native_build","symptom":"tools/native/rust/stunir-native/src/main.rs contains invalid token and core-id hashing mismatch vs verifier"},{"files":["scripts/lib/dispatch.sh","tools/native/rust/stunir-native/src/main.rs"],"id":"underscore_vs_kebab_subcommands","severity":"likely_fail","symptom":"build.sh uses spec_to_ir/gen_provenance/compile_provenance but clap defaults to kebab-case; must map or add aliases"}],"file_update_spec":[{"action":"rewrite_file","behavior":{"stunir_canon_echo":{"canonicalization":"match tools/verify_build.py canonical_json_bytes() rules (no floats, sort_keys, separators=(',',':'), utf-8)","input":"one JSON string argument","output":"canonical JSON bytes to stdout, optional trailing newline"},"stunir_dispatch":{"dispatches_commands":["check_toolchain","epoch","import_code","spec_to_ir","gen_provenance","compile_provenance","receipt"],"native_preference":{"command_name_mapping":"map underscores to hyphens when invoking native (e.g., spec_to_ir -> spec-to-ir)","native_path_candidates":["build/stunir_native"]},"receipt_routing":{"default":"use shell+python receipt generation that matches verifier (even if native exists)","env_overrides":["STUNIR_USE_NATIVE_RECEIPT=1 to use native gen-receipt when fixed","STUNIR_USE_SHELL_RECEIPT=1 to force shell receipt"]},"shell_fallbacks":{"check_toolchain":"basic presence checks + lockfile existence check","compile_provenance":"implement in python fallback matching native binary format (magic + epoch le64)","epoch":"implement in bash+python inline if native missing","gen_provenance":"call tools/gen_provenance.py directly as fallback","import_code":"implement in bash+python inline if native missing (stable order, sha256 each file, forward-slash relpaths)","spec_to_ir":"implement in bash+python inline if native missing (hash build/spec.json bytes; emit deterministic IR JSON object)"}}},"must_export_bash_functions":["log_info","log_warn","log_err","stunir_canon_echo","stunir_dispatch"],"path":"scripts/lib/dispatch.sh"},{"action":"rewrite_file","behavior":{"stunir_write_build_receipt":{"cli_contract":{"flags":["--toolchain-lock PATH","--in-bin PATH","--out-receipt PATH"],"optional_flags":["--epoch-json PATH (default build/epoch.json)"]},"output_receipt_shape":{"argv":"deterministic string list (no host-dependent absolute paths)","build_epoch":"int from epoch json","epoch":{"selected_epoch":"int","source":"string"},"inputs":"deterministic list; recommended include toolchain-lock and target as kind=file","schema":"stunir.receipt.build.v1","sha256":"sha256(target bytes)","status":"success","target":"<same as --in-bin path>","tool":"null (recommended in strict mode unless you also provide correct sha256)","toolchain_sha256":"sha256(toolchain-lock bytes)"},"receipt_core_id_sha256":{"core_object_fields":["schema","target","status","build_epoch","sha256","epoch","inputs","tool","argv"],"hash":"sha256(canonical_json_bytes(core_object))","must_match":"tools/verify_build.py compute_receipt_core_id()","no_newline_in_hash_input":true},"serialization":"canonical JSON (stunir-json-c14n-v1) with optional trailing newline"}},"must_export_bash_functions":["stunir_write_build_receipt"],"path":"scripts/lib/receipt.sh"},{"action":"edit_file","do_not_change":["Existing implemented commands Epoch, ImportCode, SpecToIr, GenProvenance, CompileProvenance behavior unless needed for determinism/c14n"],"path":"tools/native/rust/stunir-native/src/main.rs","required_changes":["Fix compile error in GenReceipt branch: replace File::open(‚åñ)? with File::open(&target)?","Change receipt_core_id computation to match verifier: hash canonical core object bytes WITHOUT newline","Ensure produced receipt JSON is canonical: use BTreeMap for receipt and core objects; keep integers (no floats)","Add clap aliases or dispatch mapping support so build.sh underscore commands can still hit native (preferred: keep mapping in dispatch; optional: add alias attributes in clap)"]}],"ground_truth_urls":{"build_sh":"https://raw.githubusercontent.com/emstar-en/STUNIR/devsite/scripts/build.sh","discover_toolchain_sh":"https://raw.githubusercontent.com/emstar-en/STUNIR/devsite/tools/discover_toolchain.sh","dispatch_sh":"https://raw.githubusercontent.com/emstar-en/STUNIR/devsite/scripts/lib/dispatch.sh","gen_provenance_py":"https://raw.githubusercontent.com/emstar-en/STUNIR/devsite/tools/gen_provenance.py","native_main_rs":"https://raw.githubusercontent.com/emstar-en/STUNIR/devsite/tools/native/rust/stunir-native/src/main.rs","receipt_sh":"https://raw.githubusercontent.com/emstar-en/STUNIR/devsite/scripts/lib/receipt.sh","verify_build_py":"https://raw.githubusercontent.com/emstar-en/STUNIR/devsite/tools/verify_build.py","verify_sh":"https://raw.githubusercontent.com/emstar-en/STUNIR/devsite/scripts/verify.sh"},"pipeline_simulation_local_strict":{"entrypoint":"scripts/build.sh","steps":[{"inputs":["repo tools/discover_toolchain.sh","host tools: python3, bash, git, etc."],"n":0,"name":"toolchain lock","notes":["build.sh runs stunir_dispatch check_toolchain if lock exists, else runs tools/discover_toolchain.sh"],"outputs":["build/local_toolchain.lock.json"]},{"inputs":["env SOURCE_DATE_EPOCH (optional)"],"n":1,"name":"epoch","outputs":["build/epoch.json"],"verifier_requires":["build/epoch.json must be canonical JSON (stunir-json-c14n-v1)"]},{"inputs":["src/ directory (optional)"],"n":2,"name":"import_code","notes":["If src/ missing, build.sh writes a canonical minimal spec object with kind=spec, modules=[]"],"outputs":["build/spec.json"]},{"inputs":["build/spec.json"],"n":3,"name":"spec_to_ir","outputs":["build/ir.json"]},{"inputs":["build/local_toolchain.lock.json","build/epoch.json","build/ir.json"],"n":3.1,"name":"receipt for build/ir.json","outputs":["receipts/spec_ir.json"],"verifier_requires":["receipts/spec_ir.json canonical JSON","schema == stunir.receipt.build.v1","receipt_core_id_sha256 equals verifier compute_receipt_core_id()","build_epoch + epoch.* match build/epoch.json","sha256 binds to build/ir.json"]},{"inputs":["epoch (int)","epoch_source (string)"],"n":4,"name":"gen_provenance","outputs":["build/provenance.json","build/provenance.h"],"verifier_requires":["build/provenance.json reproducible by tools/gen_provenance.py (byte-for-byte)","build/provenance.json canonical JSON"]},{"inputs":["build/provenance.json"],"n":5,"name":"compile_provenance","outputs":["build/provenance.bin"]},{"inputs":["build/local_toolchain.lock.json","build/epoch.json","build/provenance.bin"],"n":6,"name":"receipt for build/provenance.bin","outputs":["receipts/prov_emit.json"]},{"n":7,"name":"manifests","notes":["Empty ir_manifest files[] and empty ir_bundle_manifest entries[] are acceptable if asm/ir/*.dcbor does not exist"],"outputs":["receipts/ir_manifest.json","receipts/ir_bundle_manifest.json"],"verifier_requires":["both manifests must be canonical JSON","ir_bundle_manifest.bundle_sha256 must match sha256(build/ir.json)"]}]},"repo":{"branch":"devsite","name":"emstar-en/STUNIR"},"scope":{"explicitly_ignore":["python route as gold standard","lisp targets/routes unless explicitly referenced"],"focus":"compiled-binaries route (native-first) + local strict verifier compatibility"},"task_id":"stunir_complete_compiled_binaries_route_local_strict"},"schema":"stunir.issues.plan.v1","severity":"blocking","status":"open","title":"Complete compiled-binaries route (native-first) + local strict verifier compatibility"}
