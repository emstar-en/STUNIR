{"category":["pipeline","build"],"evidence":[{"lines":{"end":120,"start":1},"note":"Current local build entrypoint writes build/spec.json + build/ir.json, hard-codes provenance epoch=0, writes placeholder receipts/ir_manifest.json, and does not emit bin/prov_emit.","path":"scripts/build.sh","sha256":"62e9cfb279b0c0f1519117f570d27e8c40146fb0cef802398765160523f17b58","snippet_sha256":"62e9cfb279b0c0f1519117f570d27e8c40146fb0cef802398765160523f17b58"},{"lines":{"end":1010,"start":899},"note":"Defines strict-mode required receipts/manifests and local verification contract (paths + canonical JSON + receipt core-id hashing).","path":"tools/verify_build.py","sha256":"7eb1cee982e44b32a3d3e795ec36b287912fba522bcbfb65d0f8a1659b9c4bb8","snippet_sha256":"b5b22f084e45aa12b032d19c38c3d2f4adc7cf8cf2bfc17ec7ba8557dcd44bc2"},{"lines":{"end":90,"start":1},"note":"Demonstrates one implementation of the verifier-aligned build graph (existence proof; the contract is in tools/verify_build.py).","path":"scripts/build_docker.sh","sha256":"8af694aadf57adb39a0a53e508a107af7da5f4b55dd4a1e381537f9fe76ee3fc","snippet_sha256":"5234b5dda5bb8905ae382da486a76c8e48e81b39d8060855df1a92803f5cc161"}],"expected":["One canonical local build graph for strict mode that produces the artifact set verified by tools/verify_build.py local mode.","Native-first routing: when a pinned compiled tool is available, use it by default; fall back to Python; shell last, while preserving identical canonical JSON and receipt core-id hashing.","scripts/build.sh outputs: build/epoch.json, build/provenance.json, build/provenance.h, asm/spec_ir.txt, asm/ir/*.dcbor, bin/prov_emit, receipts/spec_ir.json, receipts/prov_emit.json, receipts/ir_manifest.json, receipts/ir_bundle_manifest.json."],"id":"ISSUE.BUILD.0003","impact":{"breaks_build":true,"breaks_local_verify_strict":true,"breaks_receipt_generation":true},"proposed_fixes":[{"description":"Rewrite scripts/build.sh to match the verifier local-strict artifact/receipt graph (asm/, bin/, receipts/). Change targets/paths: asm/spec_ir.txt, asm/ir/*.dcbor (+ receipts/ir_manifest.json), build/provenance.{json,h} from roots spec and asm and selected epoch, compile tools/prov_emit.c to bin/prov_emit, and record receipts for asm/spec_ir.txt and bin/prov_emit under schema stunir.receipt.build.v1.","touched_paths":["scripts/build.sh"]},{"description":"Implement a real dispatcher in scripts/lib/dispatch.sh: define stunir_dispatch and any required helpers (including canonical JSON echo), define routing precedence (native-first when build/stunir_native exists, then Python tools/, then shell), and define the behavior of check_toolchain (e.g., run tools/discover_toolchain.sh or validate an existing build/local_toolchain.lock.json).","touched_paths":["scripts/lib/dispatch.sh"]},{"description":"Stop writing placeholder manifests. Ensure receipts/ir_manifest.json reflects the actual asm/ir/*.dcbor set (strict requires set equality) and ensure receipts/ir_bundle_manifest.json matches the actual bundle bytes and segment table.","touched_paths":["scripts/build.sh","scripts/lib/dispatch.sh"]}],"related":["ISSUE.BUILD.0001","ISSUE.BUILD.0002","ISSUE.DISPATCH.0001","ISSUE.DISPATCH.0002","ISSUE.MANIFEST.0001","ISSUE.PROV.0001","ISSUE.RECEIPT.0001","ISSUE.NATIVE.0001","ISSUE.NATIVE.0002"],"reproduction":["set -euxo pipefail","./scripts/build.sh","./scripts/verify.sh --local --strict"],"root_causes":[{"details":"scripts/build.sh orchestrates an alternate build graph (build/* IR/prov stubs) that diverges from the verifier's local-strict contract.","type":"pipeline_split"},{"details":"Dispatcher interface (subcommands, naming, routing precedence, and check_toolchain semantics) is not defined/implemented, so the compiled route cannot be primary.","type":"missing_contract"}],"schema":"stunir.issues.issue.v1","severity":"blocking","status":"open","symptoms":["scripts/build.sh emits build/spec.json, build/ir.json, build/provenance.bin and placeholder manifests; tools/verify_build.py --local --strict expects asm/, bin/, and verifier-shaped receipts.","scripts/build.sh calls stunir_dispatch subcommands that are currently undefined (dispatch missing) and includes a check_toolchain step that has no defined dispatcher/backend contract.","Local strict verification cannot be made native-first until the build graph and dispatcher contract are explicitly defined and enforced."],"title":"Define canonical local-strict build graph + dispatch contract for native-first route (align scripts/build.sh outputs with verifier, not build/* stubs)","workarounds":[{"commands":["./scripts/build_docker.sh","./scripts/verify.sh --local --strict"],"description":"Use the docker pipeline until the local native-first graph matches the verifier contract."}]}
