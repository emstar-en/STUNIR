# STUNIR Prolog Targets

This directory contains code generators for Prolog-family logic programming languages.

## Supported Targets

### SWI-Prolog (`swi_prolog`)

The primary Prolog target, generating code for [SWI-Prolog](https://www.swi-prolog.org/), the most widely-used open-source Prolog implementation.

**Features:**
- Module declarations with exports
- Facts and rules
- DCG (Definite Clause Grammar) rules
- Cut (!) and negation-as-failure (\\+)
- Dynamic and multifile predicates
- Type hints (PlDoc-style comments)
- Deterministic output for reproducibility

## Usage

### Basic Usage

```python
from targets.prolog.swi_prolog import SWIPrologEmitter, SWIPrologConfig

# Create emitter with default config
emitter = SWIPrologEmitter()

# Define IR
ir = {
    "module": "family",
    "exports": [{"predicate": "grandparent", "arity": 2}],
    "clauses": [
        {"kind": "fact", "predicate": "parent", "args": [
            {"kind": "atom", "value": "tom"},
            {"kind": "atom", "value": "bob"}
        ]},
        {"kind": "rule",
         "head": {"kind": "compound", "functor": "grandparent", "args": [
             {"kind": "variable", "name": "X"},
             {"kind": "variable", "name": "Z"}
         ]},
         "body": [
             {"kind": "compound", "functor": "parent", "args": [
                 {"kind": "variable", "name": "X"},
                 {"kind": "variable", "name": "Y"}
             ]},
             {"kind": "compound", "functor": "parent", "args": [
                 {"kind": "variable", "name": "Y"},
                 {"kind": "variable", "name": "Z"}
             ]}
         ]}
    ]
}

# Generate code
result = emitter.emit(ir)
print(result.code)
```

### Output

```prolog
/*
 * STUNIR Generated SWI-Prolog Module
 * Module: family
 * Generated: 2026-01-28 10:30:00
 * 
 * This file was automatically generated by STUNIR.
 * Do not edit manually.
 */

:- module(stunir_family, [grandparent/2]).

%% parent/2
%% grandparent/2

parent(tom, bob).

grandparent(X, Z) :-
    parent(X, Y),
    parent(Y, Z).
```

### Configuration Options

```python
config = SWIPrologConfig(
    module_prefix="myapp",      # Prefix for module names
    emit_module=True,           # Generate module declaration
    emit_comments=True,         # Generate header comments
    emit_type_hints=True,       # Generate %% pred/N hints
    indent="    ",              # Indentation string
    line_width=80,              # Line width limit
    use_tabling=False,          # Enable :- table declarations
    use_constraints=False,      # Enable CLP(FD) support
    emit_timestamps=True,       # Include timestamp in header
    emit_sha256=True,           # Include hash in result
)

emitter = SWIPrologEmitter(config)
```

## Logic IR

The Prolog emitters use the Logic IR extension (`tools/ir/logic_ir.py`) which provides:

### Terms

| Kind | Description | Example |
|------|-------------|--------|
| `variable` | Logic variable | `{"kind": "variable", "name": "X"}` |
| `atom` | Prolog atom | `{"kind": "atom", "value": "hello"}` |
| `compound` | Compound term | `{"kind": "compound", "functor": "f", "args": [...]}` |
| `list_term` | Prolog list | `{"kind": "list_term", "elements": [...], "tail": ...}` |
| `anonymous` | Anonymous var | `{"kind": "anonymous"}` |

### Clauses

| Kind | Description | Example |
|------|-------------|--------|
| `fact` | Ground clause | `{"kind": "fact", "predicate": "p", "args": [...]}` |
| `rule` | Head :- Body | `{"kind": "rule", "head": {...}, "body": [...]}` |

### Goals

| Kind | Description |
|------|-------------|
| `compound` | Call predicate |
| `cut` | Cut (!) |
| `negation` | Negation-as-failure (\\+) |
| `unification` | X = Y |

## Unification Algorithm

The Logic IR includes a complete unification algorithm implementation:

```python
from tools.ir.logic_ir import Variable, Atom, Compound, unify, UnificationError

X = Variable("X")
a = Atom("hello")

# Basic unification
subst = unify(X, a)
assert subst.get(X) == a

# Compound unification
t1 = Compound("f", [X, Atom("b")])
t2 = Compound("f", [Atom("a"), Variable("Y")])
subst = unify(t1, t2)
# X -> a, Y -> b
```

## DCG Support

The emitter supports Definite Clause Grammars:

```python
ir = {
    "module": "parser",
    "clauses": [],
    "dcg_rules": [
        {
            "head": {"kind": "compound", "functor": "sentence", "args": []},
            "body": [
                {"kind": "nonterminal", "term": {"kind": "compound", "functor": "noun_phrase", "args": []}},
                {"kind": "nonterminal", "term": {"kind": "compound", "functor": "verb_phrase", "args": []}}
            ]
        },
        {
            "head": {"kind": "compound", "functor": "noun_phrase", "args": []},
            "body": [
                {"kind": "terminal", "terminals": ["the"]},
                {"kind": "nonterminal", "term": {"kind": "compound", "functor": "noun", "args": []}}
            ]
        }
    ]
}
```

Generates:

```prolog
sentence --> noun_phrase, verb_phrase.
noun_phrase --> [the], noun.
```

## Testing

Run tests:

```bash
python -m pytest tests/ir/test_logic_ir.py -v
python -m pytest tests/codegen/test_swi_prolog_generator.py -v
```

## Future Targets

- GNU Prolog
- SICStus Prolog
- YAP Prolog
- XSB Prolog

## See Also

- [SWI-Prolog Documentation](https://www.swi-prolog.org/pldoc/)
- [Logic IR Schema](../../schemas/logic_ir.json)
- [Logic IR Implementation](../../tools/ir/logic_ir.py)
