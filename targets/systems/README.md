# STUNIR Systems Languages Emitters

**Version:** 1.0  
**Phase:** 9A  

## Overview

This package provides code emitters for systems programming languages:
- **Ada Emitter** - Generates Ada 2012+ code with SPARK formal verification support
- **D Emitter** - Generates D language code with templates, CTFE, and contracts

## Module Structure

```
targets/systems/
├── __init__.py        # Package exports
├── ada_emitter.py     # Ada code generator (~800 lines)
├── d_emitter.py       # D code generator (~600 lines)
└── README.md          # This file
```

## Ada Emitter

### Features

- Package specifications (.ads) and bodies (.adb)
- Type declarations (records, arrays, enums, access types)
- Subprogram declarations with full contracts
- Task types and bodies
- Protected types and bodies
- SPARK annotations:
  - `SPARK_Mode` pragma
  - `Pre` and `Post` aspects
  - `Contract_Cases`
  - `Global` and `Depends` specifications
  - Loop invariants and variants
  - Ghost code
- Exception handling
- Deterministic manifest generation

### Usage

```python
from targets.systems import AdaEmitter
from ir.systems import Package, Subprogram, Parameter, TypeRef, Mode

emitter = AdaEmitter()

pkg = Package(
    name='Math_Utils',
    spark_mode=True,
    subprograms=[...]
)

# Get specification and body
spec, body = emitter.emit_package(pkg)

# Or emit with manifest
result = emitter.emit(pkg)
print(result.spec_code)  # .ads content
print(result.body_code)  # .adb content
print(result.manifest)   # Build manifest
```

### Generated Output Example

**Specification (.ads):**
```ada
--  Auto-generated by STUNIR Ada Emitter
pragma SPARK_Mode (On);

package Math_Utils is

   function Abs_Value (X : Integer) return Natural
      with SPARK_Mode => On,
           Pre => (X /= -2147483648),
           Global => null;

end Math_Utils;
```

**Body (.adb):**
```ada
pragma SPARK_Mode (On);

package body Math_Utils is

   function Abs_Value (X : Integer) return Natural is
   begin
      if (X >= 0) then
         return X;
      else
         return -X;
      end if;
   end Abs_Value;

end Math_Utils;
```

### Type Mappings

| IR Type | Ada Type |
|---------|----------|
| `i32` | `Interfaces.Integer_32` |
| `i64` | `Interfaces.Integer_64` |
| `f32` | `Float` |
| `f64` | `Long_Float` |
| `bool` | `Boolean` |
| `string` | `String` |

## D Emitter

### Features

- Module declarations
- Struct and class definitions
- Template definitions
- CTFE-capable functions
- Mixin templates
- Contracts (in/out/invariant)
- Memory safety attributes (@safe, @trusted, @system)
- Deterministic manifest generation

### Usage

```python
from targets.systems import DEmitter
from ir.systems import Package, Subprogram, SafetyLevel

emitter = DEmitter()

pkg = Package(
    name='utils',
    subprograms=[
        Subprogram(
            name='max',
            safety_level=SafetyLevel.SAFE,
            is_pure=True,
            ...
        )
    ]
)

# Generate module code
code = emitter.emit_module(pkg)

# Or emit with manifest
result = emitter.emit(pkg)
print(result.code)     # .d content
print(result.manifest) # Build manifest
```

### Generated Output Example

```d
// Auto-generated by STUNIR D Emitter
module utils;

int max(int a, int b) @safe pure nothrow
in (a >= 0)
in (b >= 0)
out (result; result >= a && result >= b)
{
    if ((a > b)) {
        return a;
    } else {
        return b;
    }
}
```

### Type Mappings

| IR Type | D Type |
|---------|--------|
| `i8` | `byte` |
| `i32` | `int` |
| `i64` | `long` |
| `f32` | `float` |
| `f64` | `double` |
| `bool` | `bool` |
| `string` | `string` |

## Manifest Generation

Both emitters generate deterministic build manifests:

```python
result = emitter.emit(pkg)
manifest = result.manifest

# Manifest structure:
# {
#     'schema': 'stunir.manifest.targets.ada.v1',
#     'generator': 'stunir.ada.emitter',
#     'epoch': 1706540000,
#     'ir_hash': 'sha256...',
#     'outputs': {
#         'spec': {'hash': '...', 'size': 1234},
#         'body': {'hash': '...', 'size': 5678}
#     },
#     'manifest_hash': 'sha256...'
# }
```

## Configuration

### Ada Emitter

```python
emitter = AdaEmitter(config={
    'indent_size': 3,        # Spaces per indent level
    'spark_mode': True,      # Default SPARK mode
})
```

### D Emitter

```python
emitter = DEmitter(config={
    'indent_size': 4,                    # Spaces per indent level  
    'default_safety': SafetyLevel.SAFE,  # Default safety level
})
```

## Testing

Run the test suite:

```bash
cd /home/ubuntu/stunir_repo
python -m pytest tests/codegen/test_systems_emitters.py -v
```

## Related Components

- **ir/systems/** - Systems IR definitions
- **tests/codegen/test_systems_emitters.py** - Emitter tests
- **HLI_SYSTEMS_LANGUAGES.md** - High-Level Implementation document
