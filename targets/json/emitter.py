#!/usr/bin/env python3
"""STUNIR Json Emitter - JSON serialization and deserialization emitter

This tool is part of the targets → json pipeline stage.
It converts STUNIR IR to Json format.

Generated by: STUNIR Emitter Generator v1.0
Timestamp: 2026-01-31T02:35:20.939899Z

Usage:
    emitter.py <ir.json> --output=<dir> [options]
    emitter.py --help
"""

import json
import hashlib
import time
import sys
import argparse
from pathlib import Path
from typing import Dict, List, Any, Optional


def canonical_json(data: Dict) -> str:
    """Generate RFC 8785 / JCS subset canonical JSON."""
    return json.dumps(data, sort_keys=True, separators=(',', ':'))


def compute_sha256(content: str) -> str:
    """Compute SHA256 hash of content."""
    if isinstance(content, str):
        content = content.encode('utf-8')
    return hashlib.sha256(content).hexdigest()


class JsonEmitter:
    """Emitter for Json code generation."""
    
    # Type mappings from STUNIR IR to Json
    TYPE_MAP = {
        'i32': 'int32',
        'i64': 'int64',
        'f32': 'float',
        'f64': 'double',
        'bool': 'boolean',
        'string': 'string',
        'void': 'void',
    }
    
    def __init__(self, ir_data: Dict[str, Any], out_dir: Path, options: Optional[Dict] = None):
        """Initialize Json emitter.
        
        Args:
            ir_data: STUNIR Intermediate Reference data
            out_dir: Output directory for generated files
            options: Optional configuration dictionary
        """
        self.ir_data = ir_data
        self.out_dir = Path(out_dir)
        self.options = options or {}
        self.generated_files: List[Dict[str, Any]] = []
        self.epoch = int(time.time())
    
    def _write_file(self, path: str, content: str) -> Path:
        """Write content to file and track it.
        
        Args:
            path: Relative path within output directory
            content: File content
            
        Returns:
            Full path to written file
        """
        full_path = self.out_dir / path
        full_path.parent.mkdir(parents=True, exist_ok=True)
        full_path.write_text(content, encoding='utf-8', newline='\n')
        
        self.generated_files.append({
            'path': str(path),
            'sha256': compute_sha256(content),
            'size': len(content.encode('utf-8')),
            'timestamp': self.epoch,
        })
        
        return full_path
    
    def _map_type(self, ir_type: str) -> str:
        """Map IR type to Json type.
        
        Args:
            ir_type: STUNIR IR type name
            
        Returns:
            Json type name
        """
        return self.TYPE_MAP.get(ir_type, 'int32')
    
    def emit_function(self, func_name: str, params: str, body: str) -> str:
        """Generate function code.
        
        Args:
            func_name: Function name
            params: Parameter list
            body: Function body code
            
        Returns:
            Generated function code
        """
        code_lines = [
            f"function {func_name}({params}) {{",
            body,
            "}",
            "",
        ]
        return "\n".join(code_lines)
    
    def emit_module(self, module_name: str) -> str:
        """Generate complete module code.
        
        Args:
            module_name: Module name
            
        Returns:
            Generated module code
        """
        header = [
            "/* STUNIR Generated Json Code */",
            f"/* Module: {module_name} */",
            "/* Generator: Python Pipeline */",
            f"/* Timestamp: {time.strftime('%Y-%m-%d %H:%M:%S', time.gmtime(self.epoch))} */",
            "",
        ]
        
        return "\n".join(header) + "\n// Json implementation goes here\n"
    
    def run(self) -> Dict[str, Any]:
        """Execute emission process.
        
        Returns:
            Manifest with generated file information
        """
        try:
            module_name = self.ir_data.get('module', 'unnamed')
            
            # Generate main output
            code = self.emit_module(module_name)
            self._write_file(f"{module_name}.json", code)
            
            # Create manifest
            manifest = {
                'schema': 'stunir_manifest_v0',
                'category': 'json',
                'module': module_name,
                'generator': 'python',
                'timestamp': self.epoch,
                'files': self.generated_files,
            }
            
            return manifest
            
        except Exception as e:
            print(f"Error during emission: {e}", file=sys.stderr)
            raise


def main():
    """CLI entry point."""
    parser = argparse.ArgumentParser(
        description='STUNIR Json Emitter'
    )
    parser.add_argument('ir_file', help='Input IR JSON file')
    parser.add_argument('--output', '-o', required=True, help='Output directory')
    parser.add_argument('--pretty_print', action='store_true', help='Enable pretty_print')
    parser.add_argument('--validation', action='store_true', help='Enable validation')
    parser.add_argument('--streaming', action='store_true', help='Enable streaming')
    parser.add_argument('--minification', action='store_true', help='Enable minification')
    
    args = parser.parse_args()
    
    # Load IR data
    with open(args.ir_file, 'r') as f:
        ir_data = json.load(f)
    
    # Run emitter
    emitter = JsonEmitter(ir_data, args.output, vars(args))
    manifest = emitter.run()
    
    # Write manifest
    manifest_path = Path(args.output) / 'manifest.json'
    manifest_path.write_text(json.dumps(manifest, indent=2))
    
    print(f"✅ Generated {len(manifest['files'])} file(s) in {args.output}")
    return 0


if __name__ == '__main__':
    sys.exit(main())
