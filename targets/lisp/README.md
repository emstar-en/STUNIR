# STUNIR Lisp Target Family

Code emitters for Lisp-family programming languages.

## Overview

The Lisp target family provides code emission for 8 Lisp dialects across two phases:

### Phase 5A: Core Lisp (Complete)
- **Common Lisp** - ANSI Common Lisp with CLOS and ASDF support
- **Scheme** - R7RS Scheme with proper tail calls
- **Clojure** - JVM-hosted Lisp with immutable data structures
- **Racket** - Language-oriented programming with contracts

### Phase 5B: Extended Lisp (Complete)
- **Emacs Lisp** - GNU Emacs extension language with lexical binding
- **Guile** - GNU Scheme with GOOPS object system and FFI
- **Janet** - Modern embeddable Lisp with fibers and PEG
- **Hy** - Python Lisp with full Python interop

## Architecture

```
targets/lisp/
├── base.py              # LispEmitterBase - shared functionality
├── __init__.py          # Package exports
├── README.md            # This file
│
├── common_lisp/         # Phase 5A
│   ├── emitter.py
│   ├── types.py
│   └── __init__.py
│
├── scheme/              # Phase 5A
│   ├── emitter.py
│   ├── types.py
│   └── __init__.py
│
├── clojure/             # Phase 5A
│   ├── emitter.py
│   ├── types.py
│   └── __init__.py
│
├── racket/              # Phase 5A
│   ├── emitter.py
│   ├── types.py
│   └── __init__.py
│
├── emacs_lisp/          # Phase 5B
│   ├── emitter.py
│   ├── types.py
│   └── __init__.py
│
├── guile/               # Phase 5B
│   ├── emitter.py
│   ├── types.py
│   └── __init__.py
│
├── janet/               # Phase 5B
│   ├── emitter.py
│   ├── types.py
│   └── __init__.py
│
└── hy/                  # Phase 5B
    ├── emitter.py
    ├── types.py
    └── __init__.py
```

## Usage

### Emacs Lisp

```python
from targets.lisp import EmacsLispEmitter, EmacsLispConfig
from pathlib import Path

config = EmacsLispConfig(
    target_dir=Path("./output"),
    lexical_binding=True,
    emit_provide=True
)
emitter = EmacsLispEmitter(config)

ir = {
    "module": "my-utils",
    "functions": [{
        "name": "add",
        "params": [{"name": "a", "type": "i32"}, {"name": "b", "type": "i32"}],
        "return_type": "i32",
        "body": [{"kind": "return", "value": {"kind": "binary_op", "op": "+",
            "left": {"kind": "var", "name": "a"},
            "right": {"kind": "var", "name": "b"}}}]
    }]
}

result = emitter.emit(ir)
print(result.code)
```

Output:
```elisp
;;; my-utils.el --- Generated module ; -*- lexical-binding: t; -*-

;;; Code:

(require 'cl-lib)

(defun add (a b)
  (+ a b))

(provide 'my-utils)
;;; my-utils.el ends here
```

### Guile (GNU Scheme)

```python
from targets.lisp import GuileEmitter, GuileConfig

config = GuileConfig(
    target_dir=Path("./output"),
    emit_goops=True
)
emitter = GuileEmitter(config)

result = emitter.emit(ir)
```

Output:
```scheme
(define-module (stunir my-utils)
  #:use-module (oop goops)
  #:export (add))

(define (add a b)
  (+ a b))
```

### Janet

```python
from targets.lisp import JanetEmitter, JanetConfig

config = JanetConfig(
    target_dir=Path("./output"),
    emit_structs=True
)
emitter = JanetEmitter(config)

result = emitter.emit(ir)
```

Output:
```janet
# Generated by STUNIR Janet Emitter
# Module: my-utils

(defn add
  [a b]
  (+ a b))
```

### Hy (Python Lisp)

```python
from targets.lisp import HyEmitter, HyConfig

config = HyConfig(
    target_dir=Path("./output"),
    emit_type_annotations=True
)
emitter = HyEmitter(config)

result = emitter.emit(ir)
```

Output:
```hy
;;; Generated by STUNIR Hy Emitter

(defn add
  "Add two numbers."
  [^int a ^int b] -> int
  (+ a b))
```

## Type Mapping

### Emacs Lisp Types

| IR Type | Emacs Lisp |
|---------|------------|
| i32, i64 | integer |
| f64 | float |
| bool | boolean (t/nil) |
| string | string |
| array | vector |

### Guile Types (GOOPS)

| IR Type | Guile |
|---------|-------|
| i32, i64 | `<integer>` |
| f64 | `<real>` |
| bool | #t / #f |
| void | `*unspecified*` |
| any | `<top>` |

### Janet Types

| IR Type | Janet |
|---------|-------|
| i32, f64 | number |
| bool | true / false |
| void | nil |
| list | tuple |
| array | array |

### Hy Types (Python)

| IR Type | Hy/Python |
|---------|-----------|
| i32, i64 | int |
| f64 | float |
| bool | True / False |
| string | str |
| void | None |

## Configuration Options

### EmacsLispConfig

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| lexical_binding | bool | True | Enable lexical binding mode |
| emit_provide | bool | True | Emit provide statement |
| use_cl_lib | bool | True | Require cl-lib |

### GuileConfig

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| emit_goops | bool | True | Generate GOOPS classes |
| emit_ffi | bool | False | Generate FFI bindings |
| r7rs_mode | bool | False | R7RS compatibility |

### JanetConfig

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| emit_structs | bool | True | Generate struct definitions |
| emit_peg | bool | False | Generate PEG patterns |
| use_shortfn | bool | True | Use short fn syntax |

### HyConfig

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| emit_type_annotations | bool | True | Python type hints |
| emit_docstrings | bool | True | Python docstrings |
| use_threading_macros | bool | True | Use -> and ->> |

## Testing

Run Phase 5B tests:
```bash
python -m pytest tests/codegen/test_emacs_lisp_generator.py -v
python -m pytest tests/codegen/test_guile_generator.py -v
python -m pytest tests/codegen/test_janet_generator.py -v
python -m pytest tests/codegen/test_hy_generator.py -v
```

Run all Lisp tests:
```bash
python -m pytest tests/codegen/test_*_generator.py -v
```

## Special Features

### Emacs Lisp
- Lexical binding header
- Byte-compilation compatible
- Interactive function support
- Hook and advice patterns

### Guile
- GOOPS object system
- Module system with exports
- FFI bindings
- Named let for loops

### Janet
- PEG patterns
- Fiber-based concurrency
- Struct definitions
- Short function syntax

### Hy
- Full Python interop
- Type annotations
- Python class generation
- Threading macros

## Phase 5B Statistics

- **4 emitters** implemented
- **49 tests** passing
- **~1,800 lines** of Python code
- **4 HLI documents** created

## References

- [Emacs Lisp Manual](https://www.gnu.org/software/emacs/manual/elisp.html)
- [Guile Reference Manual](https://www.gnu.org/software/guile/manual/)
- [Janet Documentation](https://janet-lang.org/docs/)
- [Hy Documentation](https://docs.hylang.org/)
