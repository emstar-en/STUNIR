# Expert System Emitters

**Phase:** 7A (Expert Systems Foundation)  
**Status:** Complete

## Overview

The Expert System Emitters generate code for industry-standard rule engine formats:

- **CLIPS**: C Language Integrated Production System (NASA)
- **Jess**: Java Expert System Shell

## Architecture

```
targets/expert_systems/
├── __init__.py           # Package exports
├── base.py               # Base emitter class
├── clips_emitter.py      # CLIPS emitter
├── jess_emitter.py       # Jess emitter
└── README.md             # This documentation
```

## Quick Start

### CLIPS Emitter

```python
from ir.rules import *
from targets.expert_systems import CLIPSEmitter

# Create a rule base
rb = RuleBase(
    name="example",
    templates=[
        FactTemplate("person", [("name", "string"), ("age", "i32")])
    ],
    rules=[
        Rule(
            name="greet",
            conditions=[
                PatternCondition(
                    template_name="person",
                    patterns=[("name", VariablePattern("n"))]
                )
            ],
            actions=[
                PrintoutAction(items=["Hello ", "?n", "crlf"])
            ]
        )
    ],
    initial_facts=[
        Fact(template_name="person", slots={"name": "John", "age": 30})
    ]
)

# Emit CLIPS code
emitter = CLIPSEmitter()
result = emitter.emit(rb)
print(result.code)
```

**Output:**
```clips
;;;; CLIPS Expert System: example
;;;; Generated by STUNIR clips Emitter v6.4

(deftemplate person
   (slot name (type STRING))
   (slot age (type INTEGER)))

(deffacts example-initial-facts
   (person (name "John") (age 30)))

(defrule greet
   (person (name ?n))
   =>
   (printout t "Hello " ?n crlf))
```

### Jess Emitter

```python
from targets.expert_systems import JessEmitter

# Basic Jess emission
emitter = JessEmitter()
result = emitter.emit(rb)
print(result.code)

# With Java integration
jess = JessEmitter(java_integration=True)
jess.add_java_import("java.util.ArrayList")
jess.add_java_import("java.io.File")
result = jess.emit(rb)
```

**Output with Java integration:**
```lisp
;;;; Jess Expert System: example
;;;; Generated by STUNIR jess Emitter v7.1
;;;; Java Integration Enabled

(import java.io.File)
(import java.util.ArrayList)

(deftemplate person
   (slot name (type STRING))
   (slot age (type INTEGER)))
...
```

## CLIPS Syntax Reference

### Templates (deftemplate)

```clips
(deftemplate person
   "A person record"
   (slot name (type STRING))
   (slot age (type INTEGER) (default 0))
   (multislot hobbies (type SYMBOL)))
```

### Rules (defrule)

```clips
(defrule adult-check
   "Check if person is an adult"
   (declare (salience 10))
   ?f <- (person (name ?n) (age ?a&:(>= ?a 18)))
   =>
   (printout t ?n " is an adult" crlf))
```

### Facts (deffacts)

```clips
(deffacts initial-data
   (person (name "John") (age 30))
   (person (name "Jane") (age 25)))
```

### Functions (deffunction)

```clips
(deffunction square (?x)
   (* ?x ?x))
```

## Jess Java Integration

Jess provides seamless Java integration:

### Creating Java Objects

```python
emitter = JessEmitter(java_integration=True)

# Generate constructor call
code = emitter.emit_java_new("ArrayList")
# Output: (new ArrayList)

code = emitter.emit_java_new("ArrayList", 10)
# Output: (new ArrayList 10)
```

### Calling Java Methods

```python
# Instance method
code = emitter.emit_java_call("list", "add", "item")
# Output: (call ?list add "item")

# Static method
code = emitter.emit_java_static_call("Math", "sqrt", 16)
# Output: (call Math sqrt 16)

# Field access
code = emitter.emit_java_get("obj", "field")
# Output: (get-member ?obj field)
```

## Type Mapping

| IR Type | CLIPS Type | Jess Type |
|---------|------------|----------|
| i8-i32 | INTEGER | INTEGER |
| i64 | INTEGER | LONG |
| f32 | FLOAT | FLOAT |
| f64 | FLOAT | DOUBLE |
| bool | SYMBOL | SYMBOL |
| string | STRING | STRING |
| symbol | SYMBOL | SYMBOL |
| any | ?VARIABLE | ANY |

## Manifest Generation

Both emitters generate deterministic manifests:

```python
result = emitter.emit(rb)
manifest = result.manifest

# Structure:
{
    "schema": "stunir.manifest.expert_systems.v1",
    "generator": "stunir.clips.emitter",
    "dialect": "clips",
    "version": "6.4",
    "rulebase": "example",
    "statistics": {
        "rules": 1,
        "templates": 1,
        "initial_facts": 1,
        "functions": 0
    },
    "output": {
        "hash": "sha256...",
        "size": 256,
        "lines": 15
    },
    "manifest_hash": "sha256..."
}
```

## Supported Features

### Conditions

- Pattern matching (template and ordered facts)
- Variable binding with constraints
- Wildcards (? and $?)
- Test conditions
- NOT conditions
- Fact binding (?f <-)

### Actions

- assert - Add facts
- retract - Remove facts
- modify - Change fact slots
- bind - Bind variables
- printout - Output text
- halt - Stop execution
- Function calls

### Declarations

- salience - Rule priority
- auto-focus - Automatic focus
- Documentation strings

## Testing

```bash
python -m pytest tests/codegen/test_expert_system_emitters.py -v
```

## Related Components

- `ir/rules/` - Rule-based IR
- `ir/rules/forward_chaining.py` - Inference engine
- `manifests/` - Manifest generation
