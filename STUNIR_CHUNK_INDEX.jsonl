{"chunk_id": "STUNIR_ANTI_PATTERNS.md::chunk::0000", "path": "STUNIR_ANTI_PATTERNS.md", "source_git_sha": "1e58f978bb91669f0f1631b398ab5202eb03e1d6", "heading": "STUNIR Anti-Patterns & Forbidden Actions", "text": "# STUNIR Anti-Patterns & Forbidden Actions"}
{"chunk_id": "STUNIR_ANTI_PATTERNS.md::chunk::0001", "path": "STUNIR_ANTI_PATTERNS.md", "source_git_sha": "1e58f978bb91669f0f1631b398ab5202eb03e1d6", "heading": "\ud83d\uded1 CRITICAL: READ BEFORE GENERATING CODE", "text": "## \ud83d\uded1 CRITICAL: READ BEFORE GENERATING CODE\n\nSTUNIR is a **deterministic build system**. Standard CI/CD practices often violate its core theorems.\nIf you suggest any of the following, you are breaking the build."}
{"chunk_id": "STUNIR_ANTI_PATTERNS.md::chunk::0002", "path": "STUNIR_ANTI_PATTERNS.md", "source_git_sha": "1e58f978bb91669f0f1631b398ab5202eb03e1d6", "heading": "1. The \"PATH\" Trap", "text": "### 1. The \"PATH\" Trap\n- **BAD:** `python3 script.py` or `gcc main.c` (Relying on system PATH)\n- **GOOD:** `$STUNIR_TOOL_PYTHON script.py` or `$STUNIR_TOOL_CC main.c`\n- **WHY:** `PATH` is a determinism leak. We do not know which version of a tool we are getting."}
{"chunk_id": "STUNIR_ANTI_PATTERNS.md::chunk::0003", "path": "STUNIR_ANTI_PATTERNS.md", "source_git_sha": "1e58f978bb91669f0f1631b398ab5202eb03e1d6", "heading": "2. The \"Network\" Trap", "text": "### 2. The \"Network\" Trap\n- **BAD:** `pip install requests`, `npm install`, `cargo build` (fetching crates)\n- **GOOD:** All dependencies must be vendored in `inputs/` or `tools/`.\n- **WHY:** The build phase is **OFFLINE**. Network access is only allowed in the explicit \"Discovery/Fetch\" phase, never in `build.sh`."}
{"chunk_id": "STUNIR_ANTI_PATTERNS.md::chunk::0004", "path": "STUNIR_ANTI_PATTERNS.md", "source_git_sha": "1e58f978bb91669f0f1631b398ab5202eb03e1d6", "heading": "3. The \"Timestamp\" Trap", "text": "### 3. The \"Timestamp\" Trap\n- **BAD:** `datetime.now()`, `date`, `touch file`\n- **GOOD:** Use `STUNIR_BUILD_EPOCH` or `SOURCE_DATE_EPOCH`.\n- **WHY:** Builds must be bit-for-bit identical whether run today or next year."}
{"chunk_id": "STUNIR_ANTI_PATTERNS.md::chunk::0005", "path": "STUNIR_ANTI_PATTERNS.md", "source_git_sha": "1e58f978bb91669f0f1631b398ab5202eb03e1d6", "heading": "4. The \"JSON\" Trap", "text": "### 4. The \"JSON\" Trap\n- **BAD:** `json.dump(data, f)` (Default formatting)\n- **GOOD:** `json.dump(data, f, sort_keys=True, separators=(',', ':'))`\n- **WHY:** JSON serialization is non-deterministic by default (whitespace, key order). We need Canonical JSON for hashing."}
{"chunk_id": "STUNIR_ANTI_PATTERNS.md::chunk::0006", "path": "STUNIR_ANTI_PATTERNS.md", "source_git_sha": "1e58f978bb91669f0f1631b398ab5202eb03e1d6", "heading": "5. The \"Python Dependency\" Trap", "text": "### 5. The \"Python Dependency\" Trap\n- **BAD:** Assuming Python is available for orchestration logic.\n- **GOOD:** Write orchestration in POSIX `sh`. Use Python only if `STUNIR_TOOL_PYTHON` is set.\n- **WHY:** STUNIR must run in \"Shell Primary\" mode (Profile 3) on constrained systems."}
{"chunk_id": "STUNIR_ANTI_PATTERNS.md::chunk::0007", "path": "STUNIR_ANTI_PATTERNS.md", "source_git_sha": "1e58f978bb91669f0f1631b398ab5202eb03e1d6", "heading": "6. The \"AbsolutePath\" Trap (in Artifacts)", "text": "### 6. The \"AbsolutePath\" Trap (in Artifacts)\n- **BAD:** Embedding `/home/user/stunir/build/...` in a binary or generated file.\n- **GOOD:** Use relative paths or deterministic placeholders (`/src`, `/build`).\n- **WHY:** The build directory varies per user. Artifacts must be portable."}
{"chunk_id": "STUNIR_ARCHITECTURE.mermaid::chunk::0000", "path": "STUNIR_ARCHITECTURE.mermaid", "source_git_sha": "32e3f0f025fbcc3fe599632e132f754c6a46fafe", "heading": "STUNIR_ARCHITECTURE.mermaid", "text": "graph TD\n    %% Nodes\n    User[User / Model]\n    Spec[Spec Files (JSON)]\n    Disc[Discovery Script]\n    Lock[Toolchain Lock (JSON)]\n    Build[Build Script (sh)]\n    Norm[Normalizer (Py/Native)]\n    IR[Intermediate Ref (dCBOR)]\n    Gen[Generator]\n    Art[Artifacts (Bin/Src)]\n    Receipt[Receipt (KV/JSON)]\n\n    %% Flow\n    User -->|Authors| Spec\n    Disc -->|Scans Host| Lock\n    Lock -->|Injects Tools| Build\n    Spec -->|Input| Build\n    Build -->|Orchestrates| Norm\n    Norm -->|Produces| IR\n    IR -->|Input| Gen\n    Gen -->|Produces| Art\n    Build -->|Records| Receipt\n\n    %% Relationships\n    Receipt -.->|Binds| Spec\n    Receipt -.->|Binds| Lock\n    Receipt -.->|Binds| IR\n    Receipt -.->|Binds| Art\n\n    %% Subgraphs\n    subgraph \"Determinism Boundary\"\n        Build\n        Norm\n        IR\n        Gen\n        Art\n        Receipt\n    end\n\n    subgraph \"Host Environment (Untrusted)\"\n        Disc\n        Lock\n    end\n"}
{"chunk_id": "scripts/lib/receipt.sh::chunk::0000", "path": "scripts/lib/receipt.sh", "source_git_sha": "463817a862adef2bd17fa507ea577fa8f920de89", "heading": "receipt.sh", "text": "#!/usr/bin/env bash\n# scripts/lib/receipt.sh\n# Shell implementation of receipt generation\n\nsource scripts/lib/json_canon.sh\n\n# cmd_gen_receipt <target> <status> <epoch> <tool_name> <tool_path> <tool_hash> <tool_ver>\ncmd_gen_receipt() {\n    local target=\"$1\"\n    local status=\"$2\"\n    local epoch=\"$3\"\n    local t_name=\"$4\"\n    local t_path=\"$5\"\n    local t_hash=\"$6\"\n    local t_ver=\"$7\"\n    shift 7\n    # argv is remaining args\n\n    # 1. Construct Tool Info (Sorted Keys: tool_name, tool_path, tool_sha256, tool_version)\n    # Note: 'tool_name' comes before 'tool_path'? \n    # Alphabetical: tool_name, tool_path, tool_sha256, tool_version\n    # n, p, s, v. Correct.\n\n    # We need to construct the inner object string first\n    local tool_json=\"{\\\"tool_name\\\":\\\"$t_name\\\",\\\"tool_path\\\":\\\"$t_path\\\",\\\"tool_sha256\\\":\\\"$t_hash\\\",\\\"tool_version\\\":\\\"$t_ver\\\"}\"\n\n    # 2. Construct Receipt (Sorted Keys)\n    # receipt_argv\n    # receipt_build_epoch\n    # receipt_epoch_json\n    # receipt_inputs\n    # receipt_schema\n    # receipt_status\n    # receipt_target\n    # receipt_tool\n\n    # Argv array construction\n    local argv_json=\"[\"\n    local first=1\n    for arg in \"$@\"; do\n        if [[ $first -eq 0 ]]; then argv_json+=\",\"; fi\n        argv_json+=\"\\\"$arg\\\"\"\n        first=0\n    done\n    argv_json+=\"]\"\n\n    # Inputs (empty for now)\n    local inputs_json=\"{}\"\n\n    # Assemble final JSON\n    # Note: We manually ensure alphabetical order of keys here.\n    echo -n \"{\"\n    echo -n \"\\\"receipt_argv\\\":$argv_json,\"\n    echo -n \"\\\"receipt_build_epoch\\\":$epoch,\"\n    echo -n \"\\\"receipt_epoch_json\\\":\\\"build/epoch.json\\\",\"\n    echo -n \"\\\"receipt_inputs\\\":$inputs_json,\"\n    echo -n \"\\\"receipt_schema\\\":\\\"stunir.receipt.build.v1\\\",\"\n    echo -n \"\\\"receipt_status\\\":\\\"$status\\\",\"\n    echo -n \"\\\"receipt_target\\\":\\\"$target\\\",\"\n    echo -n \"\\\"receipt_tool\\\":$tool_json\"\n    echo \"}\"\n}\n"}
{"chunk_id": "scripts/build.sh::chunk::0000", "path": "scripts/build.sh", "source_git_sha": "8a04d9d90a1e6c8e1409f9677e7ee1af28066004", "heading": "build.sh", "text": "#!/usr/bin/env bash\n# scripts/build.sh\n# STUNIR Master Build Script (Polyglot Dispatch)\n\n# Source core library\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\nsource \"$SCRIPT_DIR/lib/stunir_core.sh\"\n\n# --- Configuration ---\nLOCKFILE=\"build/local_toolchain.lock.json\"\n\n# --- 1. Bootstrap / Discovery ---\nif [ ! -f \"$LOCKFILE\" ]; then\n    log_info \"Lockfile not found. Running discovery...\"\n    bash \"$SCRIPT_DIR/discovery.sh\"\nfi\n\n# --- 2. Orchestration ---\nlog_info \"Starting Build Orchestration...\"\n\n# --- 3. Dispatch to Semantic Engine ---\n\nNATIVE_BIN=\"\"\nPYTHON_MINIMAL=\"tools/python/stunir_minimal.py\"\n\n# Priority 1: Compiled Native (Rust)\nif [ -f \"tools/native/rust/target/debug/stunir-rust\" ]; then\n    NATIVE_BIN=\"tools/native/rust/target/debug/stunir-rust\"\nelif [ -f \"tools/native/rust/target/release/stunir-rust\" ]; then\n    NATIVE_BIN=\"tools/native/rust/target/release/stunir-rust\"\nfi\n\n# Priority 2: Minimal Python (if Native missing)\nif [ -z \"$NATIVE_BIN\" ] && [ -f \"$PYTHON_MINIMAL\" ]; then\n    # Check if we have python3\n    PYTHON_PATH=$(grep '\"python\":' \"$LOCKFILE\" | grep -o '\"path\": \"[^\"]*\"' | cut -d'\"' -f4)\n    if [ -n \"$PYTHON_PATH\" ]; then\n        log_info \"Native binary not found. Using Minimal Python Pipeline ($PYTHON_MINIMAL)...\"\n        NATIVE_BIN=\"$PYTHON_PATH $PYTHON_MINIMAL\"\n    fi\nfi\n\n# Execute Generation\nif [ -n \"$NATIVE_BIN\" ]; then\n    log_info \"Semantic Engine: $NATIVE_BIN\"\n\n    mkdir -p build/ir build/prov\n\n    # 1. Spec -> IR\n    log_info \"[Engine] Generating IR...\"\n    if [ -f \"spec/main.stunir\" ]; then\n        $NATIVE_BIN spec-to-ir --in-json \"spec/main.stunir\" --out-ir \"build/ir/main.ir\"\n    fi\n\n    # 2. Gen Provenance\n    log_info \"[Engine] Generating Provenance...\"\n    echo '{\"timestamp\": \"now\"}' > build/epoch.json\n    if [ -f \"build/ir/main.ir\" ]; then\n        $NATIVE_BIN gen-provenance --in-ir \"build/ir/main.ir\" --epoch-json \"build/epoch.json\" --out-prov \"build/prov/main.prov\"\n    fi\n\nelse\n    log_warn \"No Semantic Engine found (Native or Python). Skipping Generation.\"\nfi\n\n# --- 4. Shell-Native Verification ---\nlog_info \"Running Shell-Native Verification...\"\nif [ -f \"build/ir/main.ir\" ] && [ -f \"build/prov/main.prov\" ]; then\n    bash \"$SCRIPT_DIR/verify_shell.sh\" \"build/ir/main.ir\" \"build/prov/main.prov\"\nelse\n    log_warn \"Artifacts missing, skipping verification.\"\nfi\n\n# --- 5. Manifest Generation ---\nmkdir -p dist\nlog_info \"Generating build manifest...\"\ngenerate_manifest \"scripts\" \"dist/manifest_scripts.txt\"\n\nlog_info \"Build Complete.\"\n"}
