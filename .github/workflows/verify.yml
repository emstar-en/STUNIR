name: STUNIR Verify (strict)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Ensure exec bits (repo portability)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/*.sh || true
          chmod +x tools/*.sh || true
          chmod +x tools/*.py || true

      - name: Build + strict verify
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/build.sh
          ./scripts/verify.sh --local --strict

  clean_smoke_then_verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Ensure exec bits (repo portability)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/*.sh || true
          chmod +x tools/*.sh || true
          chmod +x tools/*.py || true

      - name: Clean script smoke test (does not delete docs)
        shell: bash
        run: |
          set -euo pipefail

          # Create some fake generated artifacts to ensure clean.sh actually cleans
          mkdir -p build _verify_build receipts tools/__pycache__
          echo "junk" > build/junk.txt
          echo "{}" > receipts/spec_ir.json
          echo "{}" > receipts/prov_emit.json

          # Run the cleaner
          ./scripts/clean.sh

          # Assert it removed generated artifacts
          test ! -e build
          test ! -e _verify_build
          test ! -e tools/__pycache__ || true
          test ! -e receipts/spec_ir.json
          test ! -e receipts/prov_emit.json

          # Assert it preserved tracked docs
          test -f receipts/README.md
          test -d asm || true

      - name: spec_to_ir tool smoke
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/build.sh
          python3 -m py_compile tools/spec_to_ir.py
          python3 tools/spec_to_ir.py --spec-root spec --out /tmp/ir.from.tool.json

      - name: Receipt binding smoke (spec/ir/prov/toolchain)
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/build.sh
          python3 - <<'PY'
          import hashlib, json
          from pathlib import Path

          def sha256_file(p: Path) -> str:
              h = hashlib.sha256()
              with p.open("rb") as f:
                  for chunk in iter(lambda: f.read(1<<20), b""):
                      h.update(chunk)
              return h.hexdigest()

          def load_json(p: Path):
              return json.loads(p.read_text(encoding="utf-8"))

          def all_string_values(x):
              if isinstance(x, str):
                  yield x
              elif isinstance(x, dict):
                  for k, v in x.items():
                      yield from all_string_values(k)
                      yield from all_string_values(v)
              elif isinstance(x, list):
                  for v in x:
                      yield from all_string_values(v)

          spec_h = sha256_file(Path("build/spec.json"))
          ir_h   = sha256_file(Path("build/ir.json"))
          prov_h = sha256_file(Path("build/provenance.json"))
          tool_h = sha256_file(Path("build/local_toolchain.lock.json"))

          ir = load_json(Path("build/ir.json"))
          assert ir.get("spec_sha256") == spec_h

          rcpt = load_json(Path("build/receipt.json"))
          strings = set(all_string_values(rcpt))
          for h in (spec_h, ir_h, prov_h, tool_h):
              assert h in strings
          print("OK: receipt binding smoke passed")
          PY

      - name: Build + strict verify (after clean)
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/build.sh
          ./scripts/verify.sh --local --strict
