name: STUNIR CI/CD Pipeline

on:
  push:
    branches: [main, develop, "feature/**"]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================
  # Python Pipeline Tests
  # ============================================
  python-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pyyaml
          pip install -e .
      
      - name: Run Python unit tests
        run: |
          python -m pytest tests/ -v --tb=short -x --ignore=tests/rust --ignore=tests/spark
      
      - name: Run Python pipeline tests
        run: |
          python test_v0.8.4.py || true
      
      - name: Test spec_to_ir
        run: |
          python tools/spec_to_ir.py --help
          echo '{"module": "test", "functions": []}' > /tmp/test_spec.json
          python tools/spec_to_ir.py /tmp/test_spec.json /tmp || true
      
      - name: Test ir_to_code
        run: |
          python tools/ir_to_code.py --help || true
      
      - name: Measure Python coverage
        run: |
          python -m pytest tests/ --cov=tools --cov-report=xml --ignore=tests/rust --ignore=tests/spark || true
      
      - name: Upload Python coverage
        uses: codecov/codecov-action@v3
        with:
          files: coverage.xml
          flags: python
          fail_ci_if_error: false

  # ============================================
  # Rust Pipeline Tests
  # ============================================
  rust-tests:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy
      
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            tools/rust/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build Rust tools
        working-directory: tools/rust
        run: |
          cargo build --release
      
      - name: Run Rust unit tests
        working-directory: tools/rust
        run: |
          cargo test --release || true
      
      - name: Run Rust pipeline tests
        run: |
          python3 tests/rust/unit/test_spec_to_ir.py tools/rust/target/release/stunir_spec_to_ir || true
          python3 tests/rust/unit/test_ir_to_code.py tools/rust/target/release/stunir_ir_to_code || true
      
      - name: Run Rust integration tests
        run: |
          python3 tests/rust/integration/test_pipeline.py . || true
      
      - name: Rust linting
        working-directory: tools/rust
        run: |
          cargo fmt -- --check || true
          cargo clippy -- -D warnings || true

  # ============================================
  # SPARK/Ada Pipeline Tests
  # ============================================
  spark-tests:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install GNAT
        run: |
          sudo apt-get update
          sudo apt-get install -y gnat gprbuild || true
      
      - name: Build SPARK tools
        working-directory: tools/spark
        run: |
          gprbuild -P stunir_tools.gpr 2>/dev/null || echo "SPARK build skipped (GNAT not available)"
      
      - name: Run SPARK unit tests
        run: |
          if [ -f tools/spark/bin/stunir_spec_to_ir_main ]; then
            python3 tests/spark/unit/test_spec_to_ir.py tools/spark/bin/stunir_spec_to_ir_main || true
            python3 tests/spark/unit/test_ir_to_code.py tools/spark/bin/stunir_ir_to_code_main || true
          else
            echo "SPARK binaries not available, skipping tests"
          fi
      
      - name: Run SPARK integration tests
        run: |
          if [ -f tools/spark/bin/stunir_spec_to_ir_main ]; then
            python3 tests/spark/integration/test_pipeline.py . || true
          fi
      
      - name: SPARK proof (if gnatprove available)
        working-directory: tools/spark
        run: |
          which gnatprove && gnatprove -P stunir_tools.gpr --level=2 || echo "SPARK proof skipped"

  # ============================================
  # Cross-Pipeline Confluence Tests
  # ============================================
  confluence-tests:
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: Build all tools
        run: |
          pip install -e .
          cd tools/rust && cargo build --release
      
      - name: Run confluence tests
        run: |
          python tests/confluence_test.py || true
      
      - name: Verify determinism
        run: |
          # Generate IR twice and compare
          echo '{"module": "determinism_test", "functions": [{"name": "test", "returns": "i32", "params": [], "body": [{"type": "return", "value": "42"}]}]}' > /tmp/spec.json
          
          python tools/spec_to_ir.py /tmp/spec.json /tmp/ir1 2>/dev/null || true
          python tools/spec_to_ir.py /tmp/spec.json /tmp/ir2 2>/dev/null || true
          
          if [ -f /tmp/ir1/ir.json ] && [ -f /tmp/ir2/ir.json ]; then
            diff /tmp/ir1/ir.json /tmp/ir2/ir.json && echo "✓ Determinism verified" || echo "✗ Non-deterministic output"
          fi

  # ============================================
  # Code Quality & Linting
  # ============================================
  quality:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install linters
        run: |
          pip install flake8 black isort mypy
      
      - name: Python linting
        run: |
          flake8 tools/*.py --max-line-length=120 --ignore=E501,W503 || true
          black --check tools/*.py || true
      
      - name: Type checking
        run: |
          mypy tools/spec_to_ir.py --ignore-missing-imports || true

  # ============================================
  # Test Summary
  # ============================================
  test-summary:
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests, spark-tests, confluence-tests, quality]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## STUNIR Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Pipeline | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python   | ${{ needs.python-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust     | ${{ needs.rust-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SPARK    | ${{ needs.spark-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Confluence | ${{ needs.confluence-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality  | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
